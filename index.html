<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMMO Integration Layer - Datenfluss Visualisierung</title>
    
    <!-- vis.js Network CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            /* Swiss Federal Design Colors - CD Bund konform */
            --swiss-red: #DC0018;
            --swiss-dark: #333333;
            --swiss-gray-dark: #666666;
            --swiss-gray-medium: #999999;
            --swiss-gray-light: #CCCCCC;
            --swiss-gray-lighter: #E5E5E5;
            --swiss-gray-lightest: #F2F2F2;
            --swiss-white: #FFFFFF;
            --swiss-blue: #006699;
            --swiss-blue-light: #66AFE9;
            --swiss-green: #00703C;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Frutiger Neue", "Frutiger", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--swiss-white);
            color: var(--swiss-dark);
            line-height: 1.6;
            overflow: hidden;
        }
        
        /* CD Bund konformer Header */
        .header {
            background: var(--swiss-white);
            border-bottom: 4px solid var(--swiss-red);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--swiss-dark);
            letter-spacing: -0.01em;
            margin: 0;
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--swiss-gray-dark);
            font-weight: 400;
        }
        
        /* Kompakte Controls Bar */
        .controls {
            background: var(--swiss-gray-lightest);
            padding: 12px 24px;
            border-bottom: 1px solid var(--swiss-gray-light);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--swiss-dark);
        }
        
        select, button, input {
            padding: 8px 16px;
            border: 1px solid var(--swiss-gray-light);
            background: var(--swiss-white);
            color: var(--swiss-dark);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 0;
            font-family: inherit;
        }
        
        input[type="text"] {
            cursor: text;
        }
        
        select:hover, input:hover {
            border-color: var(--swiss-blue);
        }
        
        select:focus, input:focus {
            outline: 2px solid var(--swiss-blue);
            outline-offset: 0;
            border-color: var(--swiss-blue);
        }
        
        button {
            background: var(--swiss-blue);
            color: var(--swiss-white);
            border: none;
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0;
        }
        
        button:hover {
            background: #005580;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.danger {
            background: var(--swiss-red);
        }
        
        button.danger:hover {
            background: #B30014;
        }
        
        button.success {
            background: var(--swiss-green);
        }
        
        button.success:hover {
            background: #005530;
        }
        
        button:disabled {
            background: var(--swiss-gray-light);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Hauptcontainer f√ºr maximale Raumnutzung - FIXIERT */
        .main-container {
            display: flex;
            height: calc(100vh - 110px);
            position: relative;
            overflow: hidden;
        }
        
        /* Graph nimmt den gesamten verf√ºgbaren Raum ein */
        #network {
            flex: 1;
            background: var(--swiss-white);
            border: none;
            height: 100%;
            width: 100%;
        }
        
        /* Fehlermeldung - CD Bund konform */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--swiss-white);
            border: 2px solid var(--swiss-red);
            border-radius: 0;
            padding: 32px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .error-message h2 {
            color: var(--swiss-red);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .error-message p {
            color: var(--swiss-dark);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .error-message code {
            background: var(--swiss-gray-lightest);
            padding: 2px 6px;
            border-radius: 2px;
            font-family: "Courier New", monospace;
            font-size: 13px;
        }
        
        .error-message ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        
        .error-message li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        /* Kompakte, ausklappbare Legende */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.97);
            border: 1px solid var(--swiss-gray-light);
            padding: 16px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .legend.collapsed {
            padding: 12px 16px;
            max-width: auto;
        }
        
        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .legend-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--swiss-dark);
        }
        
        .toggle-icon {
            font-size: 14px;
            color: var(--swiss-gray-medium);
            font-weight: bold;
        }
        
        .legend-content {
            margin-top: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            border: 1px solid var(--swiss-gray-light);
            flex-shrink: 0;
        }
        
        /* Stats Panel - CD Bund konform */
        .stats-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            border: 1px solid var(--swiss-gray-light);
            padding: 12px 16px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            color: var(--swiss-dark);
            z-index: 10;
            font-weight: 500;
        }
        
        /* Edit Panel */
        .edit-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--swiss-white);
            border: 2px solid var(--swiss-blue);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
        
        .edit-panel.active {
            display: block;
        }
        
        .edit-panel h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--swiss-dark);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--swiss-gray-lighter);
        }
        
        .edit-panel .form-group {
            margin-bottom: 16px;
        }
        
        .edit-panel label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--swiss-dark);
            margin-bottom: 6px;
        }
        
        .edit-panel input,
        .edit-panel select {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
        }
        
        .edit-panel .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }
        
        .edit-panel button {
            min-width: 100px;
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Edit Mode Badge */
        .edit-mode-badge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--swiss-green);
            color: var(--swiss-white);
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 700;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
            display: none;
        }
        
        .edit-mode-badge.active {
            display: block;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .legend {
                max-width: 250px;
            }
            
            .stats-panel {
                position: relative;
                top: auto;
                right: auto;
                margin: 12px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>IMMO Integration Layer</h1>
            <div class="subtitle">Datenfluss Visualisierung - SUPERB Programm</div>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="categoryFilter">Kategorie:</label>
            <select id="categoryFilter">
                <option value="all">Alle anzeigen</option>
                <option value="dataOwner">Data Owner</option>
                <option value="extSystem">Externe Systeme</option>
                <option value="sapERP">SAP ERP</option>
                <option value="fachsystem">Fachsysteme</option>
                <option value="dokumente">Dokumente</option>
                <option value="visualisierung">Visualisierung</option>
                <option value="person">Nutzer</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="priorityFilter">Priorit√§t:</label>
            <select id="priorityFilter">
                <option value="all">Alle anzeigen</option>
                <option value="high">Hoch</option>
                <option value="medium">Mittel</option>
                <option value="low">Niedrig</option>
            </select>
        </div>
        
        <button onclick="resetView()">‚Üª Ansicht zur√ºcksetzen</button>
        <button onclick="reloadData()">üîÑ Daten neu laden</button>
        <button onclick="toggleEditMode()" id="editModeBtn">‚úèÔ∏è Editiermodus</button>
        <button onclick="exportData()">‚¨á Daten exportieren</button>
    </div>
    
    <div class="main-container">
        <div id="network"></div>
        
        <div class="legend collapsed">
            <div class="legend-header" onclick="toggleLegend()">
                <h3>Legende</h3>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="legend-content" style="display: none;">
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFF3CD;"></div>
                    <span>Data Owner</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #A8D8EA;"></div>
                    <span>Externe Systeme</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #90EE90;"></div>
                    <span>SAP ERP</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFE4B5;"></div>
                    <span>Fachsysteme</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #E6E6FA;"></div>
                    <span>Dokumente</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFB6C1;"></div>
                    <span>Visualisierung</span>
                </div>
            </div>
        </div>
        
        <div class="stats-panel" id="stats">
            Lade Daten...
        </div>
        
        <div class="edit-mode-badge" id="editModeBadge">
            EDITIERMODUS AKTIV
        </div>
    </div>
    
    <!-- Edit Panel -->
    <div class="overlay" id="overlay" onclick="closeEditPanel()"></div>
    <div class="edit-panel" id="editPanel">
        <h2 id="editPanelTitle">Element bearbeiten</h2>
        <div id="editPanelContent">
            <!-- Content will be dynamically inserted -->
        </div>
    </div>
    
    <!-- vis.js Network JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/vis-network.min.js"></script>
    
    <script>
        let network;
        let nodes;
        let edges;
        let allNodes = [];
        let allEdges = [];
        let editMode = false;
        
        // Netzwerk-Optionen - CD Bund optimiert
        const options = {
            nodes: {
                shape: 'box',
                margin: 10,
                font: {
                    size: 13,
                    face: 'Frutiger Neue, Frutiger, Helvetica, Arial',
                    color: '#333333',
                    bold: {
                        size: 14
                    }
                },
                borderWidth: 2,
                shadow: {
                    enabled: true,
                    color: 'rgba(0,0,0,0.1)',
                    size: 3,
                    x: 0,
                    y: 2
                }
            },
            edges: {
                smooth: {
                    type: 'cubicBezier',
                    forceDirection: 'horizontal',
                    roundness: 0.4
                },
                font: {
                    size: 11,
                    face: 'Frutiger Neue, Frutiger, Helvetica, Arial',
                    color: '#666666',
                    background: '#FFFFFF',
                    strokeWidth: 0
                },
                arrows: {
                    to: {
                        enabled: true,
                        scaleFactor: 0.8
                    }
                },
                length: 250
            },
            physics: {
                enabled: true,
                hierarchicalRepulsion: {
                    centralGravity: 0.3,
                    springLength: 150,
                    springConstant: 0.05,
                    nodeDistance: 200,
                    damping: 0.09
                },
                solver: 'hierarchicalRepulsion',
                stabilization: {
                    enabled: true,
                    iterations: 200,
                    fit: true
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                hideEdgesOnDrag: false,
                multiselect: editMode
            },
            layout: {
                hierarchical: {
                    enabled: false
                }
            }
        };
        
        function loadData() {
            // Versuche data.json aus dem gleichen Ordner zu laden
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    initializeNetwork(data);
                })
                .catch(error => {
                    showError(`Fehler beim Laden der data.json: ${error.message}`);
                });
        }
        
        function reloadData() {
            // Reload data.json with cache bypass
            const timestamp = new Date().getTime();
            fetch(`data.json?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear existing network
                    if (network) {
                        network.destroy();
                    }
                    // Reinitialize with new data
                    initializeNetwork(data);
                })
                .catch(error => {
                    alert(`Fehler beim Neuladen der Daten: ${error.message}`);
                });
        }
        
        function showError(message) {
            const container = document.getElementById('network');
            container.innerHTML = `
                <div class="error-message">
                    <h2>‚ö†Ô∏è Fehler beim Laden der Daten</h2>
                    <p>${message}</p>
                    <p style="margin-top: 16px;">Bitte stellen Sie sicher, dass:</p>
                    <ul style="text-align: left; margin: 16px auto; max-width: 400px;">
                        <li>Die Datei <code>data.json</code> im gleichen Ordner wie <code>index.html</code> liegt</li>
                        <li>Die JSON-Datei folgendes Format hat:<br><code>{ "nodes": [...], "edges": [...] }</code></li>
                        <li>Die Dateien korrekt auf GitHub Pages deployed sind</li>
                    </ul>
                </div>
            `;
        }
        
        function initializeNetwork(data) {
            if (!data.nodes || !data.edges) {
                showError('Ung√ºltiges Datenformat. Die Datei muss "nodes" und "edges" enthalten.');
                return;
            }
            
            allNodes = data.nodes;
            allEdges = data.edges;
            
            const container = document.getElementById('network');
            nodes = new vis.DataSet(allNodes);
            edges = new vis.DataSet(allEdges);
            
            const networkData = {
                nodes: nodes,
                edges: edges
            };
            
            network = new vis.Network(container, networkData, options);
            
            // Event Listeners
            network.on('selectNode', function(params) {
                if (editMode && params.nodes.length > 0) {
                    openNodeEditor(params.nodes[0]);
                }
            });
            
            network.on('selectEdge', function(params) {
                if (editMode && params.edges.length > 0) {
                    openEdgeEditor(params.edges[0]);
                }
            });
            
            network.on('doubleClick', function(params) {
                if (editMode && params.nodes.length === 0 && params.edges.length === 0) {
                    const pointer = params.pointer.canvas;
                    openNodeCreator(pointer);
                }
            });
            
            updateStats();
            
            // Fit after stabilization
            network.once('stabilizationIterationsDone', function() {
                network.fit({
                    animation: {
                        duration: 500,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            });
        }
        
        function toggleLegend() {
            const legend = document.querySelector('.legend');
            const content = document.querySelector('.legend-content');
            const icon = document.querySelector('.toggle-icon');
            
            legend.classList.toggle('collapsed');
            
            if (legend.classList.contains('collapsed')) {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }
        
        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            
            if (category === 'all') {
                nodes.update(allNodes.map(node => ({ ...node, hidden: false })));
            } else {
                nodes.update(allNodes.map(node => ({
                    ...node,
                    hidden: node.group !== category
                })));
            }
        }
        
        function filterByPriority() {
            const priority = document.getElementById('priorityFilter').value;
            
            if (priority === 'all') {
                edges.update(allEdges.map(edge => ({ ...edge, hidden: false })));
            } else {
                edges.update(allEdges.map(edge => ({
                    ...edge,
                    hidden: edge.priority !== priority
                })));
            }
        }
        
        function resetView() {
            if (!network) return;
            
            network.fit({
                animation: {
                    duration: 1000,
                    easingFunction: 'easeInOutQuad'
                }
            });
            
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            
            filterByCategory();
            filterByPriority();
        }
        
        function exportData() {
            if (!nodes || !edges) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }
            
            const data = {
                nodes: nodes.get(),
                edges: edges.get()
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().slice(0, 10);
            a.download = `immo-network-data-${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function updateStats() {
            if (!nodes || !edges) return;
            
            const nodeCount = nodes.length;
            const edgeCount = edges.length;
            
            const statsHtml = `Systeme: ${nodeCount} | Verbindungen: ${edgeCount}`;
            
            document.getElementById('stats').innerHTML = statsHtml;
        }
        
        // Edit Mode Functions
        function toggleEditMode() {
            editMode = !editMode;
            const badge = document.getElementById('editModeBadge');
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                badge.classList.add('active');
                btn.textContent = '‚úì Editiermodus aktiv';
                btn.classList.add('success');
                network.setOptions({ interaction: { multiselect: true } });
            } else {
                badge.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Editiermodus';
                btn.classList.remove('success');
                network.setOptions({ interaction: { multiselect: false } });
                closeEditPanel();
            }
        }
        
        function openNodeEditor(nodeId) {
            const node = nodes.get(nodeId);
            if (!node) return;
            
            const content = `
                <div class="form-group">
                    <label>Node ID:</label>
                    <input type="text" id="editNodeId" value="${node.id}" disabled>
                </div>
                <div class="form-group">
                    <label>Label (Name):</label>
                    <input type="text" id="editNodeLabel" value="${node.label || ''}">
                </div>
                <div class="form-group">
                    <label>Gruppe:</label>
                    <select id="editNodeGroup">
                        <option value="dataOwner" ${node.group === 'dataOwner' ? 'selected' : ''}>Data Owner</option>
                        <option value="extSystem" ${node.group === 'extSystem' ? 'selected' : ''}>Externe Systeme</option>
                        <option value="sapERP" ${node.group === 'sapERP' ? 'selected' : ''}>SAP ERP</option>
                        <option value="fachsystem" ${node.group === 'fachsystem' ? 'selected' : ''}>Fachsysteme</option>
                        <option value="dokumente" ${node.group === 'dokumente' ? 'selected' : ''}>Dokumente</option>
                        <option value="visualisierung" ${node.group === 'visualisierung' ? 'selected' : ''}>Visualisierung</option>
                        <option value="person" ${node.group === 'person' ? 'selected' : ''}>Nutzer</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="danger" onclick="deleteNode('${nodeId}')">üóëÔ∏è L√∂schen</button>
                    <button onclick="closeEditPanel()">Abbrechen</button>
                    <button class="success" onclick="saveNodeEdit('${nodeId}')">üíæ Speichern</button>
                </div>
            `;
            
            document.getElementById('editPanelTitle').textContent = 'Node bearbeiten';
            document.getElementById('editPanelContent').innerHTML = content;
            document.getElementById('editPanel').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function saveNodeEdit(nodeId) {
            const newLabel = document.getElementById('editNodeLabel').value;
            const newGroup = document.getElementById('editNodeGroup').value;
            
            if (!newLabel.trim()) {
                alert('Bitte geben Sie einen Label ein.');
                return;
            }
            
            // Get color for the group
            const colorMap = {
                'dataOwner': '#FFF3CD',
                'extSystem': '#A8D8EA',
                'sapERP': '#90EE90',
                'fachsystem': '#FFE4B5',
                'dokumente': '#E6E6FA',
                'visualisierung': '#FFB6C1',
                'person': '#FFFFFF'
            };
            
            nodes.update({
                id: nodeId,
                label: newLabel,
                group: newGroup,
                color: colorMap[newGroup]
            });
            
            // Update in allNodes
            const index = allNodes.findIndex(n => n.id === nodeId);
            if (index !== -1) {
                allNodes[index].label = newLabel;
                allNodes[index].group = newGroup;
                allNodes[index].color = colorMap[newGroup];
            }
            
            closeEditPanel();
            updateStats();
        }
        
        function deleteNode(nodeId) {
            if (!confirm('M√∂chten Sie diesen Node wirklich l√∂schen?')) return;
            
            // Delete connected edges
            const connectedEdges = edges.get({
                filter: edge => edge.from === nodeId || edge.to === nodeId
            });
            
            connectedEdges.forEach(edge => {
                edges.remove(edge.id);
                const edgeIndex = allEdges.findIndex(e => e.id === edge.id);
                if (edgeIndex !== -1) {
                    allEdges.splice(edgeIndex, 1);
                }
            });
            
            // Delete node
            nodes.remove(nodeId);
            const nodeIndex = allNodes.findIndex(n => n.id === nodeId);
            if (nodeIndex !== -1) {
                allNodes.splice(nodeIndex, 1);
            }
            
            closeEditPanel();
            updateStats();
        }
        
        function openEdgeEditor(edgeId) {
            const edge = edges.get(edgeId);
            if (!edge) return;
            
            const allNodesList = nodes.get();
            const fromNode = allNodesList.find(n => n.id === edge.from);
            const toNode = allNodesList.find(n => n.id === edge.to);
            
            const content = `
                <div class="form-group">
                    <label>Von: ${fromNode ? fromNode.label : edge.from}</label>
                </div>
                <div class="form-group">
                    <label>Zu: ${toNode ? toNode.label : edge.to}</label>
                </div>
                <div class="form-group">
                    <label>Label:</label>
                    <input type="text" id="editEdgeLabel" value="${edge.label || ''}">
                </div>
                <div class="form-group">
                    <label>Priorit√§t:</label>
                    <select id="editEdgePriority">
                        <option value="high" ${edge.priority === 'high' ? 'selected' : ''}>Hoch</option>
                        <option value="medium" ${edge.priority === 'medium' ? 'selected' : ''}>Mittel</option>
                        <option value="low" ${edge.priority === 'low' ? 'selected' : ''}>Niedrig</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="danger" onclick="deleteEdge('${edgeId}')">üóëÔ∏è L√∂schen</button>
                    <button onclick="closeEditPanel()">Abbrechen</button>
                    <button class="success" onclick="saveEdgeEdit('${edgeId}')">üíæ Speichern</button>
                </div>
            `;
            
            document.getElementById('editPanelTitle').textContent = 'Relation bearbeiten';
            document.getElementById('editPanelContent').innerHTML = content;
            document.getElementById('editPanel').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function saveEdgeEdit(edgeId) {
            const newLabel = document.getElementById('editEdgeLabel').value;
            const newPriority = document.getElementById('editEdgePriority').value;
            
            const colorMap = {
                'high': '#FF0000',
                'medium': '#0066CC',
                'low': '#666666'
            };
            
            const widthMap = {
                'high': 4,
                'medium': 2,
                'low': 1
            };
            
            edges.update({
                id: edgeId,
                label: newLabel,
                priority: newPriority,
                color: colorMap[newPriority],
                width: widthMap[newPriority]
            });
            
            // Update in allEdges
            const index = allEdges.findIndex(e => e.id === edgeId);
            if (index !== -1) {
                allEdges[index].label = newLabel;
                allEdges[index].priority = newPriority;
                allEdges[index].color = colorMap[newPriority];
                allEdges[index].width = widthMap[newPriority];
            }
            
            closeEditPanel();
        }
        
        function deleteEdge(edgeId) {
            if (!confirm('M√∂chten Sie diese Relation wirklich l√∂schen?')) return;
            
            edges.remove(edgeId);
            const edgeIndex = allEdges.findIndex(e => e.id === edgeId);
            if (edgeIndex !== -1) {
                allEdges.splice(edgeIndex, 1);
            }
            
            closeEditPanel();
            updateStats();
        }
        
        function openNodeCreator(pointer) {
            const allNodesList = nodes.get();
            const nodeOptions = allNodesList.map(n => 
                `<option value="${n.id}">${n.label || n.id}</option>`
            ).join('');
            
            const content = `
                <div class="form-group">
                    <label>Aktion w√§hlen:</label>
                    <select id="creatorAction" onchange="updateCreatorForm()">
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="newNode">Neuen Node erstellen</option>
                        <option value="newEdge">Neue Relation erstellen</option>
                    </select>
                </div>
                <div id="creatorFormContent"></div>
            `;
            
            document.getElementById('editPanelTitle').textContent = 'Neu erstellen';
            document.getElementById('editPanelContent').innerHTML = content;
            document.getElementById('editPanel').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Store pointer position for new node creation
            window.newNodePosition = pointer;
        }
        
        function updateCreatorForm() {
            const action = document.getElementById('creatorAction').value;
            const contentDiv = document.getElementById('creatorFormContent');
            
            if (action === 'newNode') {
                contentDiv.innerHTML = `
                    <div class="form-group">
                        <label>Node ID:</label>
                        <input type="text" id="newNodeId" placeholder="z.B. B16">
                    </div>
                    <div class="form-group">
                        <label>Label (Name):</label>
                        <input type="text" id="newNodeLabel" placeholder="z.B. Neues System">
                    </div>
                    <div class="form-group">
                        <label>Gruppe:</label>
                        <select id="newNodeGroup">
                            <option value="dataOwner">Data Owner</option>
                            <option value="extSystem">Externe Systeme</option>
                            <option value="sapERP">SAP ERP</option>
                            <option value="fachsystem">Fachsysteme</option>
                            <option value="dokumente">Dokumente</option>
                            <option value="visualisierung">Visualisierung</option>
                            <option value="person">Nutzer</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button onclick="closeEditPanel()">Abbrechen</button>
                        <button class="success" onclick="createNewNode()">‚úì Node erstellen</button>
                    </div>
                `;
            } else if (action === 'newEdge') {
                const allNodesList = nodes.get();
                const nodeOptions = allNodesList.map(n => 
                    `<option value="${n.id}">${n.label || n.id}</option>`
                ).join('');
                
                contentDiv.innerHTML = `
                    <div class="form-group">
                        <label>Von Node:</label>
                        <select id="newEdgeFrom">
                            <option value="">-- Bitte w√§hlen --</option>
                            ${nodeOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Zu Node:</label>
                        <select id="newEdgeTo">
                            <option value="">-- Bitte w√§hlen --</option>
                            ${nodeOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Label:</label>
                        <input type="text" id="newEdgeLabel" placeholder="z.B. Datenfluss">
                    </div>
                    <div class="form-group">
                        <label>Priorit√§t:</label>
                        <select id="newEdgePriority">
                            <option value="high">Hoch</option>
                            <option value="medium" selected>Mittel</option>
                            <option value="low">Niedrig</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button onclick="closeEditPanel()">Abbrechen</button>
                        <button class="success" onclick="createNewEdge()">‚úì Relation erstellen</button>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = '';
            }
        }
        
        function createNewNode() {
            const nodeId = document.getElementById('newNodeId').value.trim();
            const nodeLabel = document.getElementById('newNodeLabel').value.trim();
            const nodeGroup = document.getElementById('newNodeGroup').value;
            
            if (!nodeId || !nodeLabel) {
                alert('Bitte f√ºllen Sie alle Felder aus.');
                return;
            }
            
            // Check if ID already exists
            if (nodes.get(nodeId)) {
                alert('Ein Node mit dieser ID existiert bereits.');
                return;
            }
            
            const colorMap = {
                'dataOwner': '#FFF3CD',
                'extSystem': '#A8D8EA',
                'sapERP': '#90EE90',
                'fachsystem': '#FFE4B5',
                'dokumente': '#E6E6FA',
                'visualisierung': '#FFB6C1',
                'person': '#FFFFFF'
            };
            
            const newNode = {
                id: nodeId,
                label: nodeLabel,
                group: nodeGroup,
                color: colorMap[nodeGroup],
                x: window.newNodePosition ? window.newNodePosition.x : undefined,
                y: window.newNodePosition ? window.newNodePosition.y : undefined
            };
            
            nodes.add(newNode);
            allNodes.push(newNode);
            
            closeEditPanel();
            updateStats();
        }
        
        function createNewEdge() {
            const fromId = document.getElementById('newEdgeFrom').value;
            const toId = document.getElementById('newEdgeTo').value;
            const edgeLabel = document.getElementById('newEdgeLabel').value.trim();
            const edgePriority = document.getElementById('newEdgePriority').value;
            
            if (!fromId || !toId) {
                alert('Bitte w√§hlen Sie beide Nodes aus.');
                return;
            }
            
            if (fromId === toId) {
                alert('Ein Node kann nicht mit sich selbst verbunden werden.');
                return;
            }
            
            const colorMap = {
                'high': '#FF0000',
                'medium': '#0066CC',
                'low': '#666666'
            };
            
            const widthMap = {
                'high': 4,
                'medium': 2,
                'low': 1
            };
            
            // Generate unique edge ID
            const edgeId = `edge_${Date.now()}`;
            
            const newEdge = {
                id: edgeId,
                from: fromId,
                to: toId,
                label: edgeLabel,
                priority: edgePriority,
                color: colorMap[edgePriority],
                width: widthMap[edgePriority],
                arrows: 'to'
            };
            
            edges.add(newEdge);
            allEdges.push(newEdge);
            
            closeEditPanel();
            updateStats();
        }
        
        function closeEditPanel() {
            document.getElementById('editPanel').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Event Listeners
        document.getElementById('categoryFilter').addEventListener('change', filterByCategory);
        document.getElementById('priorityFilter').addEventListener('change', filterByPriority);
        
        // Initialisierung beim Laden der Seite
        window.onload = function() {
            loadData();
        };
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditPanel();
            }
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                resetView();
            }
            if (e.key === 'e' && e.ctrlKey) {
                e.preventDefault();
                toggleEditMode();
            }
        });
    </script>
</body>
</html>
